<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecture vocale distante</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen gap-4 p-4">

  <h1 class="text-2xl font-bold">En attente de lecture distante...</h1>
  <pre id="output" class="w-full max-w-md bg-gray-800 p-3 rounded overflow-x-auto text-sm"></pre>

  <script>
    const FILE_URL = 'https://raw.githubusercontent.com/TON_UTILISATEUR/database_EnesCDE/main/divers/text.json';
    const API_URL = 'https://api.github.com/repos/TON_UTILISATEUR/database_EnesCDE/contents/divers/text.json';
    const TOKEN_URL = 'https://pkyt-database-up.vercel.app/code-source/E-CDE/Secure-token.js';

    let isReading = false;

    async function getToken() {
      const res = await fetch(TOKEN_URL);
      const data = await res.json();
      return data.GITHUB_TOKEN;
    }

    async function getSha() {
      const res = await fetch(API_URL);
      const data = await res.json();
      return data.sha;
    }

    async function updateLectureFalse(content) {
      const token = await getToken();
      const sha = await getSha();

      const newJson = {
        ...content,
        lecture: false
      };

      await fetch(API_URL, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'Lecture terminée, reset lecture:false',
          content: btoa(unescape(encodeURIComponent(JSON.stringify(newJson, null, 2)))),
          sha: sha
        })
      });
    }

    async function fetchText() {
      try {
        const res = await fetch(FILE_URL + `?cache=${Date.now()}`);
        const data = await res.json();
        document.getElementById('output').textContent = JSON.stringify(data, null, 2);

        if (data.lecture && !isReading) {
          isReading = true;

          const utterance = new SpeechSynthesisUtterance(data.say);
          utterance.lang = 'fr-FR';
          speechSynthesis.speak(utterance);

          utterance.onend = async () => {
            await updateLectureFalse(data);
            isReading = false;
          };
        }
      } catch (err) {
        document.getElementById('output').textContent = 'Erreur de récupération.';
        console.error(err);
      }
    }

    setInterval(fetchText, 2000);
    fetchText();
  </script>

</body>
</html>
