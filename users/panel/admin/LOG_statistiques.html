<!DOCTYPE html>
    <html lang="fr">
        <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <title>EnesCDE - Admin > LOG-Statistiques</title>
        <link rel="icon" type="image/png" href="https://enes-cde.vercel.app/data/img/web/favicon.png">
        
        
        <!-- Script pour ajouter dynamiquement le footer -->
        <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
        <script src="https://enes-cde.vercel.app/script/A-footer.js" defer></script>
        <script src="https://enes-cde.vercel.app/users/panel/admin/__menu__.js" defer></script>
        <script src="https://enes-cde.vercel.app/script/A-all.js" defer></script>
        <script src="./__sessions__.js"></script>
        <div id="ecde_all"></div>

    </head>
    <body class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white">
        <div class="flex h-screen">
            <!-- Menu : Deb -->
            <div id="ecde_menu"  class="w-20"></div>
            <!-- Menu : Fin -->
    
            <!-- Main Content -->
            <main class="flex-1 p-6 bg-gray-100 dark:bg-gray-800">
    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Admin - Consulter les logs :</h1>


    
                





    <h1 class="text-2xl font-bold mb-4">ğŸ“Š Statistiques des logs</h1>

    <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-800 p-4 rounded-lg">
            <h2 class="text-lg font-semibold">ğŸ“ˆ DonnÃ©es gÃ©nÃ©rales</h2>
            <p><strong>ID Reconnu :</strong> <span id="idReconnus">0</span></p>
            <p><strong>ID Inconnu :</strong> <span id="idInconnus">0</span></p>
            <p><strong>Total des vues :</strong> <span id="totalVues">0</span></p>
            <p><strong>Vues en 7 jours :</strong> <span id="vues7J">0</span></p>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg">
            <h2 class="text-lg font-semibold">ğŸŒ Pages ConsultÃ©es</h2>
            <ul id="liste_pages"></ul>
        </div>
    </div>

    <div class="mt-6 bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-semibold">ğŸ‘¤ Liste des utilisateurs</h2>
        <ul id="liste_users"></ul>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => fetchLogs());

async function fetchLogs() {
    const tokenURL = "https://pkyt-database-up.vercel.app/code-source/E-CDE/Secure-token.js";
    const repo = "database_EnesCDE";
    const owner = "PKYT-Service";
    const path = "log/users";

    try {
        // ğŸ” RÃ©cupÃ©ration du token GitHub
        const tokenData = await fetch(tokenURL).then(res => res.json());
        const headers = { "Authorization": "token " + tokenData.GITHUB_TOKEN };

        // ğŸ“‚ RÃ©cupÃ©ration des fichiers de logs
        const apiURL = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const data = await fetch(apiURL, { headers }).then(res => res.json());

        if (!Array.isArray(data)) throw new Error("Impossible de rÃ©cupÃ©rer les logs.");

        // ğŸ“¥ TÃ©lÃ©chargement des fichiers JSON en parallÃ¨le
        const filePromises = data
            .filter(file => file.name.endsWith(".json"))
            .map(async file => {
                try {
                    const content = await fetch(file.download_url).then(res => res.text());
                    return { name: file.name, content };
                } catch {
                    return null;
                }
            });

        const files = (await Promise.all(filePromises)).filter(f => f);

        // ğŸ“Š Traitement des logs
        processLogs(files);
    } catch (error) {
        console.error("âŒ Erreur rÃ©cupÃ©ration logs", error);
    }
}

function processLogs(files) {
    let idReconnus = 0, idInconnus = 0, totalVues = files.length, vues7J = 0;
    let pages = {}, users = {};

    const dateLimite = new Date();
    dateLimite.setDate(dateLimite.getDate() - 7);

    for (const { content } of files) {
        // ğŸ“Œ Extraction de l'ID utilisateur
        const matchID = content.match(/ECDE:ID\s*=\s*([\w-]+)/);
        const userID = matchID ? matchID[1] : "Inconnu";

        if (userID !== "Inconnu") {
            idReconnus++;
            users[userID] = content;
        } else {
            idInconnus++;
        }

        // ğŸ”— Extraction des URLs visitÃ©es
        const pageMatch = content.match(/### Log : #\s*(https?:\/\/\S+)/);
        if (pageMatch) {
            const page = pageMatch[1];
            pages[page] = (pages[page] || 0) + 1;
        }

        // ğŸ“… VÃ©rification si log < 7 jours
        const dateMatch = content.match(/Date\s*:\s*(\d{2})\.(\d{2})\.(\d{4})/);
        if (dateMatch) {
            const logDate = new Date(`${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`);
            if (logDate >= dateLimite) vues7J++;
        }
    }

    // ğŸ”„ Mise Ã  jour de l'interface
    updateStats(idReconnus, idInconnus, totalVues, vues7J);
    updatePageList(pages, users);
    updateUserList(users);
}

function updateStats(idReconnus, idInconnus, totalVues, vues7J) {
    document.getElementById("idReconnus").textContent = idReconnus;
    document.getElementById("idInconnus").textContent = idInconnus;
    document.getElementById("totalVues").textContent = totalVues;
    document.getElementById("vues7J").textContent = vues7J;
}

function updatePageList(pages, users) {
    const listePages = document.getElementById("liste_pages");
    listePages.innerHTML = "";
    
    const fragment = document.createDocumentFragment();

    Object.entries(pages).forEach(([page, count]) => {
        const li = document.createElement("li");
        li.textContent = `${page} (${count} vues)`;
        li.className = "cursor-pointer text-blue-400 hover:underline";
        li.onclick = () => afficherClients(page, users);
        fragment.appendChild(li);
    });

    listePages.appendChild(fragment);
}

function updateUserList(users) {
    const listeUsers = document.getElementById("liste_users");
    listeUsers.innerHTML = "";

    const fragment = document.createDocumentFragment();

    Object.entries(users).forEach(([id, info]) => {
        const li = document.createElement("li");
        li.textContent = id;
        li.className = "cursor-pointer text-green-400 hover:underline";
        li.onclick = () => afficherInfoUser(info);
        fragment.appendChild(li);
    });

    listeUsers.appendChild(fragment);
}

// ğŸ•µï¸â€â™‚ï¸ Affiche la liste des utilisateurs ayant consultÃ© une page
function afficherClients(page, users) {
    const clients = Object.keys(users).filter(id => users[id].includes(page));
    alert(`ğŸ‘¥ Clients ayant consultÃ© ${page} :\n` + (clients.length ? clients.join("\n") : "Aucun"));
}

// ğŸ” Affiche les informations d'un utilisateur
function afficherInfoUser(info) {
    alert("â„¹ï¸ Informations du compte :\n\n" + info);
}

    </script>

                <!-- Footer : Deb -->
                <div id="ecde_footer"></div>
                <!-- Footer : Fin -->
            </main>
        </div>

        

</body>
</html>
