<!DOCTYPE html>
    <html lang="fr">
        <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <title>EnesCDE - Admin > LOG-Statistiques</title>
        <link rel="icon" type="image/png" href="https://enes-cde.vercel.app/data/img/web/favicon.png">
        
        
        <!-- Script pour ajouter dynamiquement le footer -->
        <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
        <script src="https://enes-cde.vercel.app/script/A-footer.js" defer></script>
        <script src="https://enes-cde.vercel.app/users/panel/admin/__menu__.js" defer></script>
        <script src="https://enes-cde.vercel.app/script/A-all.js" defer></script>
        <script src="./__sessions__.js"></script>
        <div id="ecde_all"></div>

    </head>
    <body class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white">
        <div class="flex h-screen">
            <!-- Menu : Deb -->
            <div id="ecde_menu"  class="w-20"></div>
            <!-- Menu : Fin -->
    
            <!-- Main Content -->
            <main class="flex-1 p-6 bg-gray-100 dark:bg-gray-800">
    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Admin - Consulter les logs :</h1>


    
                





    <h1 class="text-2xl font-bold mb-4">üìä Statistiques des logs</h1>

    <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-800 p-4 rounded-lg">
            <h2 class="text-lg font-semibold">üìà Donn√©es g√©n√©rales</h2>
            <p><strong>ID Reconnu :</strong> <span id="idReconnus">0</span></p>
            <p><strong>ID Inconnu :</strong> <span id="idInconnus">0</span></p>
            <p><strong>Total des vues :</strong> <span id="totalVues">0</span></p>
            <p><strong>Vues en 7 jours :</strong> <span id="vues7J">0</span></p>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg">
            <h2 class="text-lg font-semibold">üåê Pages Consult√©es</h2>
            <ul id="liste_pages"></ul>
        </div>
    </div>

    <div class="mt-6 bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-semibold">üë§ Liste des utilisateurs</h2>
        <ul id="liste_users"></ul>
    </div>

    <script>
        async function fetchLogs() {
            const tokenURL = "https://pkyt-database-up.vercel.app/code-source/E-CDE/Secure-token.js";
            const repo = "database_EnesCDE";
            const owner = "PKYT-Service";
            const path = "log/users";

            let headers = {};
            try {
                // üîê R√©cup√©ration du token GitHub
                const tokenRes = await fetch(tokenURL);
                const tokenData = await tokenRes.json();
                headers = { "Authorization": "token " + tokenData.GITHUB_TOKEN };
            } catch (error) {
                console.error("‚ùå Erreur r√©cup√©ration token", error);
                return;
            }

            try {
                // üìÇ R√©cup√©ration des fichiers de logs
                const apiURL = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(apiURL, { headers });
                if (!response.ok) throw new Error("Impossible de r√©cup√©rer les logs.");
                
                const data = await response.json();

                let idReconnus = 0, idInconnus = 0, totalVues = 0, vues7J = 0;
                let pages = {}, users = {};

                const dateLimite = new Date();
                dateLimite.setDate(dateLimite.getDate() - 7);

                for (const file of data) {
                    if (!file.name.endsWith(".json")) continue; // Ignorer les fichiers non JSON

                    // üìú R√©cup√©ration du contenu du fichier JSON
                    const fileResponse = await fetch(file.download_url);
                    const fileText = await fileResponse.text();

                    totalVues++;
                    const matchID = fileText.match(/ECDE:ID\s*=\s*(\S+)/);
                    const userID = matchID ? matchID[1] : "Non trouv√©";

                    if (userID !== "Non trouv√©") {
                        idReconnus++;
                        users[userID] = fileText;
                    } else {
                        idInconnus++;
                    }

                    // üîó R√©cup√©ration des URLs visit√©es
                    const pageMatch = fileText.match(/### Log : #\s*(https?:\/\/\S+)/);
                    if (pageMatch) {
                        const page = pageMatch[1];
                        pages[page] = (pages[page] || 0) + 1;
                    }

                    // üìÖ V√©rification si log < 7 jours
                    const dateMatch = fileText.match(/Date\s+(\d{2}\/\d{2}\/\d{4})/);
                    if (dateMatch) {
                        const logDate = new Date(dateMatch[1].split("/").reverse().join("-"));
                        if (logDate >= dateLimite) {
                            vues7J++;
                        }
                    }
                }

                // üèÜ Mise √† jour des statistiques
                document.getElementById("idReconnus").textContent = idReconnus;
                document.getElementById("idInconnus").textContent = idInconnus;
                document.getElementById("totalVues").textContent = totalVues;
                document.getElementById("vues7J").textContent = vues7J;

                // üìå Affichage des pages consult√©es
                const listePages = document.getElementById("liste_pages");
                listePages.innerHTML = "";
                for (const [page, count] of Object.entries(pages)) {
                    const li = document.createElement("li");
                    li.textContent = `${page} (${count} vues)`;
                    li.className = "cursor-pointer text-blue-400 hover:underline";
                    li.onclick = () => afficherClients(page, users);
                    listePages.appendChild(li);
                }

                // üë§ Affichage des utilisateurs
                const listeUsers = document.getElementById("liste_users");
                listeUsers.innerHTML = "";
                for (const [id, info] of Object.entries(users)) {
                    const li = document.createElement("li");
                    li.textContent = id;
                    li.className = "cursor-pointer text-green-400 hover:underline";
                    li.onclick = () => afficherInfoUser(info);
                    listeUsers.appendChild(li);
                }
            } catch (error) {
                console.error("‚ùå Erreur r√©cup√©ration logs", error);
            }
        }

        // üïµÔ∏è‚Äç‚ôÇÔ∏è Affiche la liste des utilisateurs ayant consult√© une page
        function afficherClients(page, users) {
            let clients = Object.keys(users).filter(id => users[id].includes(page));
            alert(`üë• Clients ayant consult√© ${page} :\n` + (clients.length ? clients.join("\n") : "Aucun"));
        }

        // üîç Affiche les informations d'un utilisateur
        function afficherInfoUser(info) {
            alert("‚ÑπÔ∏è Informations du compte :\n\n" + info);
        }

        // ‚ñ∂ Charger les logs au d√©marrage
        fetchLogs();
    </script>

                <!-- Footer : Deb -->
                <div id="ecde_footer"></div>
                <!-- Footer : Fin -->
            </main>
        </div>

        

</body>
</html>
