<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EnesCDE - Admin > Panel Administratif > web manager</title>
    <link rel="icon" type="image/png" href="https://enes-cde.vercel.app/data/img/web/favicon.png" />
    
    <!-- Script pour ajouter dynamiquement le footer -->
    <script src="https://enes-cde.vercel.app/SLPECDE/main.js" type="module"></script>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://enes-cde.vercel.app/script/A-footer.js"></script>
    <script src="https://enes-cde.vercel.app/users/panel/admin/__menu__.js"></script>
    <script src="https://enes-cde.vercel.app/script/A-all.js"></script>
    <script src="./__sessions__.js"></script>
    <div id="ecde_all"></div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
</head>
<body class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white">
    <div class="flex h-screen">
        <!-- Menu : Deb -->
        <div id="ecde_menu"  class="w-20"></div>
        <!-- Menu : Fin -->

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Gestion TSL :</h1>

            <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-indigo-700 rounded-3xl p-8 text-center sm:p-16 md:px-24 md:py-20 lg:px-28">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="font-display text-4xl font-bold tracking-tight text-white sm:text-5xl lg:text-6xl">Mise a jour</h2>
                        <p class="max-w-lg text-base text-indigo-100 mx-auto mt-4 sm:text-lg">De nouvel fonctionnalitées</p>
                    </div>

                    <ul class="flex flex-wrap items-center justify-center gap-x-6 gap-y-3 text-sm font-medium text-white mt-8">
                        <li class="inline-flex items-center gap-2">
                            <svg aria-hidden="true" class="h-5 w-5 shrink-0 text-white" xmlns="http://www.w3.org/2000/svg"
                              fill="currentColor" viewBox="0 0 256 256">
                              <path d="M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"></path>
                            </svg>Redirection / Block
                        </li>
                        <li class="inline-flex items-center gap-2">
                            <svg aria-hidden="true" class="h-5 w-5 shrink-0 text-white" xmlns="http://www.w3.org/2000/svg"
                              fill="currentColor" viewBox="0 0 256 256">
                              <path d="M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"></path>
                            </svg> Warn / Maintenance
                        </li>
                        <li class="inline-flex items-center gap-2">
                            <svg aria-hidden="true" class="h-5 w-5 shrink-0 text-white" xmlns="http://www.w3.org/2000/svg"
                              fill="currentColor" viewBox="0 0 256 256">
                              <path d="M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"></path>
                            </svg>Tags devs / level
                        </li>
                        <li class="inline-flex items-center gap-2">
                            <svg aria-hidden="true" class="h-5 w-5 shrink-0 text-white" xmlns="http://www.w3.org/2000/svg"
                              fill="currentColor" viewBox="0 0 256 256">
                              <path d="M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"></path>
                            </svg> Tags Systemes / membership
                        </li>
                        <li class="inline-flex items-center gap-2">
                            <svg aria-hidden="true" class="h-5 w-5 shrink-0 text-white" xmlns="http://www.w3.org/2000/svg"
                              fill="currentColor" viewBox="0 0 256 256">
                              <path d="M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"></path>
                            </svg>Et autres
                        </li>
                    </ul>
                </div>
            </div>

            <div class="flex flex-col flex-1 w-full rounded-sm transition-colors duration-300 border-black mt-6">
                <header class="p-4 flex justify-end">
                    <b>TSL</b>
                </header>
                <main class="h-full overflow-y-auto">
                    <div class="container px-6 mx-auto grid">
                        <h2 class="text-center text-2xl font-bold my-4 text-gray-900 dark:text-gray-200">Statistique</h2>
                        <div class="flex items-center justify-center p-4 rounded-lg shadow-md text-gray-800  dark:text-gray-200">
                            <div class="grid lg:grid-cols-3 md:grid-cols-2 gap-6 w-full max-w-6xl">
                                <!-- Tile Blacklist -->
                                <div class="flex items-center p-4 rounded-lg shadow-md bg-gray-300 dark:bg-gray-700">
                                    <div class="flex flex-shrink-0 items-center justify-center h-16 w-16 rounded-lg bg-gray-400 dark:bg-gray-600">
                                        <i class="bi bi-shield-x text-3xl"></i>
                                    </div>
                                    <div class="flex-grow flex flex-col ml-4">
                                        <span class="text-gray-700 dark:text-gray-400">Blacklist</span>
                                        <span class="text-xl font-bold" id="blacklist-count">0</span>
                                    </div>
                                </div>
                                <!-- Tile Maintenance -->
                                <div class="flex items-center p-4 rounded-lg shadow-md bg-gray-300 dark:bg-gray-700">
                                    <div class="flex flex-shrink-0 items-center justify-center h-16 w-16 rounded-lg bg-gray-400 dark:bg-gray-600">
                                        <i class="bi bi-tools text-3xl"></i>
                                    </div>
                                    <div class="flex-grow flex flex-col ml-4">
                                        <span class="text-gray-700 dark:text-gray-400">Maintenance</span>
                                        <span class="text-xl font-bold" id="maintenance-count">0</span>
                                    </div>
                                </div>
                                <!-- Tile Rappel -->
                                <div class="flex items-center p-4 rounded-lg shadow-md bg-gray-300 dark:bg-gray-700">
                                    <div class="flex flex-shrink-0 items-center justify-center h-16 w-16 rounded-lg bg-gray-400 dark:bg-gray-600">
                                        <i class="bi bi-bell text-3xl"></i>
                                    </div>
                                    <div class="flex-grow flex flex-col ml-4">
                                        <span class="text-gray-700 dark:text-gray-400">Rappel</span>
                                        <span class="text-xl font-bold" id="rappel-count">0</span>
                                    </div>
                                </div>
                                <!-- Tile Redirections -->
                                <div class="flex items-center p-4 rounded-lg shadow-md bg-gray-300 dark:bg-gray-700">
                                    <div class="flex flex-shrink-0 items-center justify-center h-16 w-16 rounded-lg bg-gray-400 dark:bg-gray-600">
                                        <i class="bi bi-arrow-left-right text-3xl"></i>
                                    </div>
                                    <div class="flex-grow flex flex-col ml-4">
                                        <span class="text-gray-700 dark:text-gray-400">Redirections</span>
                                        <span class="text-xl font-bold" id="redirection-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
                        <!-- Zone de recherche -->
                        <div class="mb-4">
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Rechercher une URL..."
                                class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            />
                        </div>

                        <!-- Tableau des sites -->
                        <table id="sitesTable" class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden shadow">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">State</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commentaire</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sitesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </main>
            </div>
        </main>

        <!-- Popup -->
        <div id="popup" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
            <div class="bg-white dark:bg-gray-900 p-6 rounded-lg max-w-xl w-full relative shadow-lg">
                <button id="closePopup" class="absolute top-2 right-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
                <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Modifier le site</h3>
                <form id="popupForm" class="space-y-4">
                    <input type="hidden" id="popupSiteIndex" />
                    <div>
                        <label for="popupURL" class="block font-medium mb-1 text-gray-700 dark:text-gray-300">URL</label>
                        <input type="text" id="popupURL" class="w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" disabled />
                    </div>
                    <div>
                        <label for="popupType" class="block font-medium mb-1 text-gray-700 dark:text-gray-300">Type</label>
                        <select id="popupType" class="w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="indéfini">indéfini</option>
                            <option value="neutre">neutre</option>
                            <option value="lié">lié</option>
                            <option value="affilié">affilié</option>
                            <option value="EC2E service">EC2E service</option>
                            <option value="EC2E system">EC2E system</option>
                            <option value="développement local">développement local</option>
                            <option value="développement externe">développement externe</option>
                            <option value="développement officiel">développement officiel</option>
                            <option value="preview Git">preview Git</option>
                            <option value="preview Vercel">preview Vercel</option>
                            <option value="preview Git bot">preview Git bot</option>
                            <option value="preview Vercel bot">preview Vercel bot</option>
                            <option value="test">test</option>
                            <option value="beta">beta</option>
                            <option value="staging">staging</option>
                            <option value="production">production</option>
                            <option value="maintenance">maintenance</option>
                            <option value="application">application</option>
                        </select>
                    </div>
                    <div>
                        <label for="popupState" class="block font-medium mb-1 text-gray-700 dark:text-gray-300">State</label>
                        <select id="popupState" class="w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="indéfini">indéfini</option>
                            <option value="neutre">neutre</option>
                            <option value="lié">lié</option>
                            <option value="affilié">affilié</option>
                            <option value="EC2E service">EC2E service</option>
                            <option value="EC2E system">EC2E system</option>
                            <option value="développement local">développement local</option>
                            <option value="développement externe">développement externe</option>
                            <option value="développement officiel">développement officiel</option>
                            <option value="preview Git">preview Git</option>
                            <option value="preview Vercel">preview Vercel</option>
                            <option value="preview Git bot">preview Git bot</option>
                            <option value="preview Vercel bot">preview Vercel bot</option>
                            <option value="test">test</option>
                            <option value="beta">beta</option>
                            <option value="staging">staging</option>
                            <option value="production">production</option>
                            <option value="maintenance">maintenance</option>
                            <option value="application">application</option>
                        </select>
                    </div>
                    <div>
                        <label for="popupTags" class="block font-medium mb-1 text-gray-700 dark:text-gray-300">Tags</label>
                        <input type="text" id="popupTags" class="w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    </div>
                    <div>
                        <label for="popupComment" class="block font-medium mb-1 text-gray-700 dark:text-gray-300">Commentaire</label>
                        <textarea id="popupComment" class="w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3"></textarea>
                    </div>
                    <div>
                        <label for="popupAdmin" class="block font-medium mb-1 text-gray-700 dark:text-gray-300">Admin</label>
                        <input type="text" id="popupAdmin" class="w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="popupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500">Annuler</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-700 text-white rounded hover:bg-indigo-800">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>

    <script>
        let jsonData = null; // Contiendra les données sites

        // Fonction pour récupérer le token depuis l'URL du fichier tocken.js (ta méthode)
        async function fetchGitHubToken() {
            const tokenUrl = "https://pkyt-database-up.vercel.app/code-source/E-CDE/Secure-token.js";
            try {
                const response = await fetch(tokenUrl);
                const data = await response.json();
                return data.GITHUB_TOKEN;
            } catch (e) {
                console.error("Erreur récupération token GitHub:", e);
                return null;
            }
        }

        // Récupération des données sites via GitHub API
        async function fetchSites(githubToken) {
            if (!githubToken) {
                alert("Token GitHub non disponible");
                return;
            }
            const url = "https://api.github.com/repos/EnesCDE/PKYT-Database/contents/code-source/admin-dashboard/secute_private/TSL.json";

            const headers = {
                Authorization: `token ${githubToken}`
            };

            try {
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                // data.content est base64
                const jsonStr = atob(data.content);
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error("Erreur récupération TSL:", e);
                alert("Erreur récupération TSL");
                return null;
            }
        }

        // Fonction pour compter les stat
        function updateStats(sites) {
            const blacklist = sites.filter(s => s.Type === "blacklist" || (s.Tags && s.Tags.includes("blacklist")));
            const maintenance = sites.filter(s => s.State === "maintenance");
            const rappel = sites.filter(s => s.Type === "rappel");
            const redirection = sites.filter(s => s.Type === "redirection");

            document.getElementById("blacklist-count").textContent = blacklist.length;
            document.getElementById("maintenance-count").textContent = maintenance.length;
            document.getElementById("rappel-count").textContent = rappel.length;
            document.getElementById("redirection-count").textContent = redirection.length;
        }

        // Rendu du tableau avec les données (ou filteredSites)
        function renderTable(sites) {
            const tbody = document.getElementById("sitesTableBody");
            tbody.innerHTML = "";
            sites.forEach((site, index) => {
                const tr = document.createElement("tr");
                tr.classList.add(index % 2 === 0 ? "bg-white" : "bg-gray-100");
                tr.classList.add("dark:bg-gray-800", index % 2 === 0 ? "dark:bg-gray-800" : "dark:bg-gray-700");
                tr.innerHTML = `
                    <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${index + 1}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${site.URL || ""}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${site.Type || ""}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${site.State || ""}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${site.Tags || ""}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${site.Commentaire || ""}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${site.Admin || ""}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                        <button
                            class="text-indigo-600 hover:text-indigo-900 dark:hover:text-indigo-400"
                            onclick="openPopup(${index})"
                        >Modifier</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateStats(sites);
        }

        // Ouvrir popup avec données du site sélectionné
        function openPopup(index) {
            const site = jsonData.Sites[index];
            document.getElementById("popupSiteIndex").value = index;
            document.getElementById("popupURL").value = site.URL || "";
            document.getElementById("popupType").value = site.Type || "indéfini";
            document.getElementById("popupState").value = site.State || "indéfini";
            document.getElementById("popupTags").value = site.Tags || "";
            document.getElementById("popupComment").value = site.Commentaire || "";
            document.getElementById("popupAdmin").value = site.Admin || "";
            document.getElementById("popup").classList.remove("hidden");
        }

        // Fermer popup
        document.getElementById("closePopup").addEventListener("click", () => {
            document.getElementById("popup").classList.add("hidden");
        });
        document.getElementById("popupCancel").addEventListener("click", () => {
            document.getElementById("popup").classList.add("hidden");
        });

        // Sauvegarder modifications popup
        document.getElementById("popupForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const index = parseInt(document.getElementById("popupSiteIndex").value, 10);
            if (isNaN(index) || !jsonData) return;

            // Mise à jour locale
            jsonData.Sites[index].Type = document.getElementById("popupType").value;
            jsonData.Sites[index].State = document.getElementById("popupState").value;
            jsonData.Sites[index].Tags = document.getElementById("popupTags").value;
            jsonData.Sites[index].Commentaire = document.getElementById("popupComment").value;
            jsonData.Sites[index].Admin = document.getElementById("popupAdmin").value;

            renderTable(jsonData.Sites);
            document.getElementById("popup").classList.add("hidden");

            // Ici, tu peux ajouter la partie push sur GitHub avec token et commit via API, si besoin
            alert("Modifications sauvegardées localement. Pour pousser sur GitHub, ajoute la fonction push.");
        });

        // Filtrage recherche
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", () => {
            const filter = searchInput.value.toLowerCase();
            if (!jsonData) return;
            const filteredSites = jsonData.Sites.filter(site =>
                (site.URL || "").toLowerCase().includes(filter)
            );
            renderTable(filteredSites);
        });

        // Initialisation : fetch token, fetch données puis affichage
        (async () => {
            const token = await fetchGitHubToken();
            const data = await fetchSites(token);
            if (data) {
                jsonData = data;
                renderTable(jsonData.Sites);
            }
        })();
    </script>
</body>
</html>
